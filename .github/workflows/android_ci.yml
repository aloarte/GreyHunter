  name: Android CI & Coverage Badge

  on:
    push:
      branches: [ "main", "feature/ci_kover" ]
    pull_request:
      branches: [ "main" ]

  jobs:
    test:
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          shard: [
            ':app:testDebugUnitTest :feature:home:testDebugUnitTest :feature:createproject:testDebugUnitTest',
            ':common:data:testDebugUnitTest :common:domain:testDebugUnitTest :common:framework:testDebugUnitTest',
            ':feature:minidetail:testDebugUnitTest :feature:projectdetail:testDebugUnitTest :feature:createminiature:testDebugUnitTest'
          ]

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'
            cache: gradle

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Run Tests for Shard ${{ matrix.shard }}
          run: ./gradlew ${{ matrix.shard }}

        - name: Upload Kover Binary Report
          uses: actions/upload-artifact@v4
          with:
            name: kover-report-${{ matrix.shard }}
            path: '**/build/kover/*.bin'

    report-and-badge:
      runs-on: ubuntu-latest
      needs: test
      permissions:
        contents: write

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'
            cache: gradle

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Download all Kover reports
          uses: actions/download-artifact@v4
          with:
            path: build/kover-reports-from-shards
            pattern: kover-report-*
            merge-multiple: true

        - name: Generate Merged Kover Report
          run: ./gradlew koverXmlReportDebug --stacktrace

        - name: Generate Coverage Badge
          id: jacoco_badge
          uses: cicirello/jacoco-badge-generator@v2
          with:
            jacoco-csv-file: build/reports/kover/report.xml
            badges-directory: badges
            generate-branches-badge: true

        - name: Log coverage percentage
          run: |
            echo "coverage = ${{ steps.jacoco_badge.outputs.coverage }}"
            echo "branch coverage = ${{ steps.jacoco_badge.outputs.branches }}"

        - name: Commit and push badge
          if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/feature/ci_kover'
          run: |
            cd badges
            if [[ `git status --porcelain *.svg` ]]; then
              git config --global user.name 'github-actions[bot]'
              git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
              git add *.svg
              git commit -m "Autogenerated Kover coverage badge"
              git push
            fi

        - name: Upload HTML Report
          uses: actions/upload-artifact@v4
          with:
            name: coverage-report
            path: build/reports/kover/html
