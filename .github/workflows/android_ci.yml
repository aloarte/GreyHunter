  name: Android CI & Coverage Badge

  on:
    push:
      branches: [ "main", "feature/ci_kover" ]
    pull_request:
      branches: [ "main" ]

  jobs:
    build-and-test:
      runs-on: ubuntu-latest
      permissions:
        contents: write

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'
            cache: gradle

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Run Tests and Generate Kover Report
          run: ./gradlew clean testDebugUnitTest koverXmlReport koverHtmlReport

        - name: List Kover Reports for debugging
          run: ls -R build/reports/kover

        - name: Upload HTML Report
          uses: actions/upload-artifact@v4
          with:
            name: coverage-report
            path: build/reports/kover/html

        - name: Generate Kover Coverage Badge
          uses: tj-actions/kover-badge@v10
          with:
            kover-report-path: build/reports/kover/report.xml
            badge-path: badges/kover.svg

        - name: Commit and push badge
          if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/feature/ci_kover'
          uses: stefanzweifel/git-auto-commit-action@v5
          with:
            commit_message: "chore: Autogenerated Kover coverage badge"
            file_pattern: badges/kover.svg


